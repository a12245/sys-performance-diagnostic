name: CI-Performance-Beast-WARP

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write

jobs:
  performance-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Optimize-Kernel-Network
        run: |
          # --- æ¿€è¿›ç³»ç»Ÿä¼˜åŒ– ---
          sudo sysctl -w net.ipv4.tcp_fastopen=3
          sudo sysctl -w net.core.somaxconn=65535
          sudo sysctl -w net.ipv4.tcp_window_scaling=1
          sudo sysctl -w net.core.rmem_max=8388608
          sudo sysctl -w net.core.wmem_max=8388608
          sudo sysctl -w net.core.default_qdisc=fq
          sudo sysctl -w net.ipv4.tcp_congestion_control=bbr || echo "BBR fallback"
          ulimit -n 65535

      # --- [æ–°å¢] å®‰è£…å¹¶å¯åŠ¨ Cloudflare WARP ---
      - name: Install-WARP-Socks5
        run: |
          # 1. æ·»åŠ  Cloudflare GPG Key å’Œ Repo
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          
          # 2. å®‰è£… WARP
          sudo apt-get update && sudo apt-get install cloudflare-warp -y
          
          # 3. æ³¨å†Œå¹¶é…ç½®ä¸º SOCKS5 ä»£ç†æ¨¡å¼ (é¿å…æ¥ç®¡æ•´ä¸ªç³»ç»Ÿç½‘ç»œå¯¼è‡´ SSH/Action æ–­è¿)
          warp-cli --accept-tos registration new
          warp-cli --accept-tos mode proxy
          warp-cli --accept-tos proxy port 40000
          
          # 4. è¿æ¥
          warp-cli --accept-tos connect
          
          # 5. ç­‰å¾…è¿æ¥æˆåŠŸ
          echo "Waiting for WARP..."
          sleep 5
          for i in {1..10}; do
            STATUS=$(curl -s --socks5 127.0.0.1:40000 https://www.cloudflare.com/cdn-cgi/trace | grep "warp=on")
            if [ -n "$STATUS" ]; then
              echo "WARP is ON! ğŸš€"
              break
            fi
            sleep 2
          done

      - name: Deploy-Singbox-Core
        env:
          V_ID: ${{ secrets.VM_ID }}
        run: |
          # ä¸‹è½½ Sing-box
          curl -L -s -o sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v1.8.11/sing-box-1.8.11-linux-amd64.tar.gz"
          tar -xzf sing-box.tar.gz && mv sing-box-*/sing-box . && chmod +x sing-box

          # --- [ä¿®æ”¹] é…ç½® Sing-box èµ° WARP SOCKS5 å‡ºå£ ---
          cat <<EOF > config.json
          {
            "log": { "disabled": true },
            "dns": { "servers": [] },
            "inbounds": [
              {
                "type": "vless",
                "tag": "in-0",
                "listen": "127.0.0.1",
                "listen_port": 8080,
                "users": [{ "uuid": "$V_ID", "flow": "" }],
                "transport": {
                  "type": "ws",
                  "path": "/",
                  "early_data_header_name": "Sec-WebSocket-Protocol"
                }
              }
            ],
            "outbounds": [
              {
                "type": "socks", 
                "tag": "warp-out",
                "server": "127.0.0.1",
                "server_port": 40000,
                "version": "5"
              }
            ]
          }
          EOF

          # å¯åŠ¨ Sing-box
          nohup ./sing-box run -c config.json > /dev/null 2>&1 &
          sleep 2

      - name: Establish-Tunnel-And-Sync
        id: sync_step
        env:
          V_ID: ${{ secrets.VM_ID }}
        run: |
          # ä¸‹è½½ Cloudflared
          curl -L -s -o cloudflared "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64"
          chmod +x cloudflared
          
          # å¯åŠ¨ Tunnel (HTTP2)
          nohup ./cloudflared tunnel --url http://localhost:8080 --protocol http2 --no-autoupdate > session.log 2>&1 &
          
          echo "Waiting for Uplink..."
          for i in {1..30}; do
            sleep 2
            RAW_EP=$(grep -o 'https://.*trycloudflare.com' session.log | head -n 1 | sed 's/https:\/\///')
            if [ -n "$RAW_EP" ]; then
              break
            fi
          done

          if [ -n "$RAW_EP" ]; then
            # ä½¿ç”¨å¤§å‚åŸŸåä½œä¸ºè·³æ¿
            CDN_DOMAINS=("www.visa.com" "www.visa.com.sg" "www.wto.org" "icook.tw" "ip.sb")
            
            TOTAL_LINKS=""
            CLASH_PROXIES=""
            CLASH_GROUPS=""
            
            for DOMAIN in "${CDN_DOMAINS[@]}"; do
                ALIAS="âš¡WARP-${DOMAIN}"
                
                # VLESS Link
                LINK="vless://${V_ID}@${DOMAIN}:443?encryption=none&security=tls&type=ws&host=${RAW_EP}&sni=${RAW_EP}&path=%2F&allowInsecure=1#${ALIAS}"
                TOTAL_LINKS="${TOTAL_LINKS}${LINK}\n"
                
                # Clash Meta Block
                CLASH_PROXIES="${CLASH_PROXIES}  - name: ${ALIAS}\n    type: vless\n    server: ${DOMAIN}\n    port: 443\n    uuid: ${V_ID}\n    udp: true\n    tls: true\n    network: ws\n    servername: ${RAW_EP}\n    skip-cert-verify: true\n    client-fingerprint: chrome\n    ws-opts:\n      path: \"/\"\n      headers:\n        Host: ${RAW_EP}\n\n"
                CLASH_GROUPS="${CLASH_GROUPS}      - ${ALIAS}\n"
            done
            
            # å†™å…¥ base64 (æ—§å…¼å®¹)
            echo -e "$TOTAL_LINKS" | base64 -w 0 > system-report.dat
            
            # å†™å…¥ clash.yaml
            cat <<EOF > clash.yaml
          port: 7890
          socks-port: 7891
          allow-lan: true
          mode: rule
          log-level: info
          external-controller: 127.0.0.1:9090
          proxies:
          $(echo -e "$CLASH_PROXIES")
          proxy-groups:
            - name: ğŸš€ èŠ‚ç‚¹é€‰æ‹©
              type: select
              proxies:
                - â™»ï¸ è‡ªåŠ¨é€‰æ‹©
          $(echo -e "$CLASH_GROUPS")
            - name: â™»ï¸ è‡ªåŠ¨é€‰æ‹©
              type: url-test
              url: http://www.gstatic.com/generate_204
              interval: 300
              tolerance: 50
              proxies:
          $(echo -e "$CLASH_GROUPS")
          rules:
            - GEOIP,CN,DIRECT
            - MATCH,ğŸš€ èŠ‚ç‚¹é€‰æ‹©
          EOF
            
            # Git Push
            git config --global user.name "bot"
            git config --global user.email "bot@bot.com"
            git add system-report.dat clash.yaml
            git commit -m "update" || echo "skip"
            git push -f
          else
            exit 1
          fi

      - name: Keep-Alive
        run: |
          end=$((SECONDS+21600))
          while [ $SECONDS -lt $end ]; do
            sleep 120
          done
