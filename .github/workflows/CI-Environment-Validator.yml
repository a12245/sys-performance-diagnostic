name: CI-Performance-Beast

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write

jobs:
  performance-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Optimize-Kernel-Network
        run: |
          # --- æ¿€è¿›ç³»ç»Ÿä¼˜åŒ– (Linux Kernel Tuning) ---
          # å¼€å¯ TCP Fast Open
          sudo sysctl -w net.ipv4.tcp_fastopen=3
          # å¢åŠ æœ€å¤§è¿æ¥æ•°
          sudo sysctl -w net.core.somaxconn=65535
          # è°ƒæ•´ TCP ç¼“å†²åŒºé™åˆ¶ (æ¦¨å¹²å¸¦å®½)
          sudo sysctl -w net.ipv4.tcp_window_scaling=1
          sudo sysctl -w net.core.rmem_max=8388608
          sudo sysctl -w net.core.wmem_max=8388608
          # å¼€å¯ BBR æ‹¥å¡æ§åˆ¶ (è™½ç„¶ Action æ ¸å¿ƒé€šå¸¸å—é™ï¼Œä½†å°è¯•å¼€å¯)
          sudo sysctl -w net.core.default_qdisc=fq
          sudo sysctl -w net.ipv4.tcp_congestion_control=bbr || echo "BBR fallback"
          # å…è®¸æ›´å¤šæ‰“å¼€æ–‡ä»¶å¥æŸ„
          ulimit -n 65535

      - name: Deploy-Singbox-Core
        env:
          V_ID: ${{ secrets.VM_ID }}
        run: |
          # ä¸‹è½½ Sing-box
          curl -L -s -o sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v1.8.11/sing-box-1.8.11-linux-amd64.tar.gz"
          tar -xzf sing-box.tar.gz && mv sing-box-*/sing-box . && chmod +x sing-box

          # ç”Ÿæˆ "è£¸å¥”" é…ç½®
          # æ²¡æœ‰ä»»ä½• Logï¼Œæ²¡æœ‰ä»»ä½• Sniffï¼Œè·¯å¾„è®¾ä¸ºæ ¹ç›®å½• /
          cat <<EOF > config.json
          {
            "log": { "disabled": true },
            "dns": { "servers": [] },
            "inbounds": [
              {
                "type": "vless",
                "tag": "in-0",
                "listen": "127.0.0.1",
                "listen_port": 8080,
                "users": [{ "uuid": "$V_ID", "flow": "" }],
                "transport": {
                  "type": "ws",
                  "path": "/",
                  "early_data_header_name": "Sec-WebSocket-Protocol"
                }
              }
            ],
            "outbounds": [{ "type": "direct", "tag": "out-0" }]
          }
          EOF

          # å¯åŠ¨
          nohup ./sing-box run -c config.json > /dev/null 2>&1 &
          sleep 2

      - name: Establish-Tunnel-And-Sync
        id: sync_step
        env:
          V_ID: ${{ secrets.VM_ID }}
        run: |
          # ä¸‹è½½ Cloudflared
          curl -L -s -o cloudflared "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64"
          chmod +x cloudflared
          
          # å¯åŠ¨ Tunnel - ä½¿ç”¨ http2 åè®® (æ¯” quic æ›´çœ CPU)
          nohup ./cloudflared tunnel --url http://localhost:8080 --protocol http2 --no-autoupdate > session.log 2>&1 &
          
          echo "Waiting for Uplink..."
          
          # å¿«é€Ÿæ‰«æ
          for i in {1..30}; do
            sleep 2
            RAW_EP=$(grep -o 'https://.*trycloudflare.com' session.log | head -n 1 | sed 's/https:\/\///')
            if [ -n "$RAW_EP" ]; then
              break
            fi
          done

          if [ -n "$RAW_EP" ]; then
            # --- æé€Ÿé“¾æ¥ç”Ÿæˆ (No-Fancy-Stuff) ---
            
            # ä½¿ç”¨å¤§å‚åŸŸåä½œä¸ºè·³æ¿
            CDN_DOMAINS=("www.visa.com" "www.visa.com.sg" "www.wto.org" "icook.tw" "ip.sb")
            
            TOTAL_LINKS=""
            
            # --- [æ–°å¢] åˆå§‹åŒ– Clash é…ç½®å˜é‡ ---
            CLASH_PROXIES=""
            CLASH_GROUPS=""
            
            for DOMAIN in "${CDN_DOMAINS[@]}"; do
                ALIAS="âš¡Turbo-${DOMAIN}"
                
                # 1. ç”ŸæˆåŸæœ¬çš„ VLESS é“¾æ¥
                LINK="vless://${V_ID}@${DOMAIN}:443?encryption=none&security=tls&type=ws&host=${RAW_EP}&sni=${RAW_EP}&path=%2F&allowInsecure=1#${ALIAS}"
                TOTAL_LINKS="${TOTAL_LINKS}${LINK}\n"
                
                # 2. [æ–°å¢] ç”Ÿæˆ Clash Meta èŠ‚ç‚¹å— (YAMLæ ¼å¼)
                # æ³¨æ„ç¼©è¿›å¿…é¡»ä¸¥æ ¼
                CLASH_PROXIES="${CLASH_PROXIES}  - name: ${ALIAS}\n    type: vless\n    server: ${DOMAIN}\n    port: 443\n    uuid: ${V_ID}\n    udp: true\n    tls: true\n    network: ws\n    servername: ${RAW_EP}\n    skip-cert-verify: true\n    client-fingerprint: chrome\n    ws-opts:\n      path: \"/\"\n      headers:\n        Host: ${RAW_EP}\n\n"
                
                # è®°å½•èŠ‚ç‚¹åç”¨äºç­–ç•¥ç»„
                CLASH_GROUPS="${CLASH_GROUPS}      - ${ALIAS}\n"
            done
            
            # --- åŸæœ¬çš„ base64 å†™å…¥ ---
            echo -e "$TOTAL_LINKS" | base64 -w 0 > system-report.dat
            
            # --- [æ–°å¢] å†™å…¥ clash.yaml æ–‡ä»¶ ---
            # è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥å¯¼å…¥ä½¿ç”¨
            cat <<EOF > clash.yaml
          port: 7890
          socks-port: 7891
          allow-lan: true
          mode: rule
          log-level: info
          external-controller: 127.0.0.1:9090
          proxies:
          $(echo -e "$CLASH_PROXIES")
          proxy-groups:
            - name: ğŸš€ èŠ‚ç‚¹é€‰æ‹©
              type: select
              proxies:
                - â™»ï¸ è‡ªåŠ¨é€‰æ‹©
          $(echo -e "$CLASH_GROUPS")
            - name: â™»ï¸ è‡ªåŠ¨é€‰æ‹©
              type: url-test
              url: http://www.gstatic.com/generate_204
              interval: 300
              tolerance: 50
              proxies:
          $(echo -e "$CLASH_GROUPS")
          rules:
            - GEOIP,CN,DIRECT
            - MATCH,ğŸš€ èŠ‚ç‚¹é€‰æ‹©
          EOF
            
            # å¼ºåˆ¶æ¨é€ (å¢åŠ äº† clash.yaml)
            git config --global user.name "bot"
            git config --global user.email "bot@bot.com"
            git add system-report.dat clash.yaml
            git commit -m "update" || echo "skip"
            git push -f
          else
            exit 1
          fi

      - name: Keep-Alive
        run: |
          # æ²¡æœ‰ä»»ä½•å¤šä½™çš„æ£€æŸ¥é€»è¾‘ï¼Œçº¯å¾ªç¯ï¼Œçœ CPU
          end=$((SECONDS+21600))
          while [ $SECONDS -lt $end ]; do
            sleep 120
          done
